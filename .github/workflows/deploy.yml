name: Provision Infra + Deploy Angular

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ vars.AWS_REGION }}
  AWS_ROLE_ARN: ${{ vars.AWS_ROLE_ARN }}
  TF_STATE_BUCKET_NAME: ${{ vars.TF_STATE_BUCKET_NAME }}
  # Se você aplicou o patch do Terraform (bucket_name), use S3_BUCKET_NAME:
  S3_BUCKET_NAME: ${{ vars.S3_BUCKET_NAME }}

jobs:
  terraform:
    name: Terraform Apply
    runs-on: ubuntu-latest

    outputs:
      bucket_name: ${{ steps.tf_outputs.outputs.bucket_name }}
      distribution_id: ${{ steps.tf_outputs.outputs.distribution_id }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.5"

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${TF_STATE_BUCKET_NAME}" \
            -backend-config="key=profile/prod/terraform.tfstate" \
            -backend-config="region=${AWS_REGION}"

      - name: Terraform Plan
        run: |
          terraform plan -out=tfplan \
            -var="bucket_name=${S3_BUCKET_NAME}"

      - name: Terraform Apply
        run: terraform apply -auto-approve tfplan

      - name: Read Terraform outputs
        id: tf_outputs
        shell: bash
        run: |
          BUCKET_NAME="$(terraform output -raw bucket_name)"
          DIST_ID="$(terraform output -raw cloudfront_distribution_id)"

          echo "bucket_name=$BUCKET_NAME" >> "$GITHUB_OUTPUT"
          echo "distribution_id=$DIST_ID" >> "$GITHUB_OUTPUT"

  deploy:
    name: Build + Deploy Angular
    runs-on: ubuntu-latest
    needs: terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build Angular
        run: npm run build -- --configuration production

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: ${{ env.AWS_ROLE_ARN }}

      - name: Upload to S3 (sync)
        shell: bash
        run: |
          # Ajuste o caminho do dist se necessário:
          # Angular normalmente gera dist/<nome-do-projeto>/browser (Angular 17+) ou dist/<nome-do-projeto>
          #
          # Opção 1 (mais comum):
          # DIST_DIR="dist/<SEU_PROJETO>"
          #
          # Opção 2 (Angular SSR/Builders modernos):
          # DIST_DIR="dist/<SEU_PROJETO>/browser"

          # Tentativa automática (pega o primeiro diretório dentro de dist):
          DIST_DIR="$(ls -d dist/* | head -n 1)"
          echo "Using DIST_DIR=$DIST_DIR"

          aws s3 sync "$DIST_DIR" "s3://${{ needs.terraform.outputs.bucket_name }}/" \
            --delete \
            --only-show-errors

      - name: CloudFront Invalidation
        run: |
          aws cloudfront create-invalidation \
            --distribution-id "${{ needs.terraform.outputs.distribution_id }}" \
            --paths "/*"
